@import model.SearchResponseList
@(models: SearchResponseList, wordsFiltered: Map[String, Long], searchQuery: String)

@main("YTLytics") {
<head>
    <title>YTLytics</title>
    <link rel="stylesheet" type="text/css" href="@routes.Assets.versioned("stylesheets/ytlytics.css")">
</head>

<body>
<section id="top">
    <div class="wrapper">
        <h1>Welcome to YTLytics</h1>
        <form method="get">
            <input name="query" placeholder="Enter search terms" id="searchForm" required>
            <input type="hidden" name="sessionId" value="@models.getSessionID">
            <button type="submit" id="submitButton">Go!</button>
        </form>
    </div>
</section>

<section id="results">
    <div class="wrapper">
        <h2>Search History</h2>
        <div id="history">
        </div>
    </div>
</section>

<script>
    let sessionId = localStorage.getItem("sessionId");
    if (!sessionId) {
        sessionId = crypto.randomUUID(); // Generate a new session ID
        localStorage.setItem("sessionId", sessionId);
    }

    const socket = new WebSocket(`ws://localhost:9000/ws?sessionId=${sessionId}`);

    const historyContainer = document.getElementById("history");

    socket.onopen = () => console.log(`WebSocket connected with session ID: ${sessionId}`);
    socket.onmessage = (event) => handleNewSearch(JSON.parse(event.data));
    socket.onclose = () => console.log("WebSocket closed");
    socket.onerror = (error) => console.error("WebSocket error:", error);

    document.getElementById("submitButton").onclick = function (event) {
        event.preventDefault();
        const query = document.getElementById("searchForm").value.trim();
        if (query) {
            console.log(`Sending query: ${query}`);
            socket.send(query);
        } else {
            console.error("Query is empty. Not sending.");
        }
    };

    function handleNewSearch({ query, results }) {
        const querySection = document.createElement("div");
        querySection.classList.add("search-entry");
        querySection.innerHTML = `
            <h3>Search for: "${query}"</h3>
            <a href="/word-stats?query=${encodeURIComponent(query)}&sessionId=${sessionId}" target="_blank">Word Statistics</a>
            <ol>
                ${results.map((result) => `
                    <li class="result-item">
                        <div class="result-content">
                            <div class="text-content">
                                <p>
                                    <b>Video Title:</b>
                                    <a href="${result.videoUrl}" target="_blank">${result.title}</a>
                                    <b>Channel:</b> <a href="/channel/${result.channelId}" target="_blank">${result.channelTitle}</a>
                                    <b>Description:</b> ${result.description}
                                    <b>Tags:</b>
                                    ${result.tags.map(tag => `<a href="#" class="tag-link">${tag}</a>`).join(", ")}
                                </p>
                            </div>
                            <img src="${result.thumbnailUrl}" alt="Video Thumbnail" class="thumbnail">
                        </div>
                    </li>
                `).join("")}
            </ol>
        `;

        historyContainer.prepend(querySection);
    }
</script>
</body>
}
