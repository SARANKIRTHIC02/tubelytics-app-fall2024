@import model.SearchResponseList
@(models: SearchResponseList, wordsFiltered: Map[String, Long], searchQuery: String)

@main("YTLytics") {
    <head>
        <title>YTLytics</title>
        <link rel="stylesheet" type="text/css" href="@routes.Assets.versioned("stylesheets/ytlytics.css")">
    </head>

    <body>
        <section id="top">
            <div class="wrapper">
                <h1>Welcome to YTLytics</h1>
                <form method="get">
                    <input name="query" placeholder="Enter search terms" id="searchForm" required>
                    <input type="hidden" name="sessionId" value="@models.getSessionID">
                    <button type="submit" id="submitButton">Go!</button>
                </form>
            </div>
        </section>

        <section id="results">
            <div class="wrapper">
                <h2>Search History</h2>
                <div id="history">
                </div>
            </div>
        </section>
        <script>
                // Generate or retrieve session ID
                let sessionId = localStorage.getItem("sessionId");
                if (!sessionId) {
                    sessionId = crypto.randomUUID(); // Generate a new session ID
                    localStorage.setItem("sessionId", sessionId);
                }

                // Create WebSocket connection
                const socket = new WebSocket(`ws://localhost:9000/ws?sessionId=${sessionId}`);

                // Reference to the container for displaying search results
                const historyContainer = document.getElementById("history");

                // Log WebSocket connection status
                socket.onopen = () => console.log(`[ytlytics] WebSocket connected with session ID: ${sessionId}`);
                socket.onclose = () => console.log("[ytlytics] WebSocket closed");
                socket.onerror = (error) => console.error("[ytlytics] WebSocket error:", error);

                // Handle incoming WebSocket messages
                socket.onmessage = (event) => {
                    console.log("[ytlytics] WebSocket message received:", event.data);
                    try {
                        const parsedData = JSON.parse(event.data);
                        console.log("[ytlytics] Parsed data:", parsedData);
                        handleNewSearch(parsedData);
                    } catch (error) {
                        console.error("[ytlytics] Error parsing WebSocket message:", error);
                    }
                };

                // Handle form submission
                document.getElementById("submitButton").onclick = function (event) {
                    event.preventDefault();
                    const query = document.getElementById("searchForm").value.trim();
                    if (query) {
                        console.log(`[ytlytics] Sending query: ${query}`);
                        socket.send(query); // Send the query to the WebSocket server
                    } else {
                        console.error("[ytlytics] Query is empty. Not sending.");
                    }
                };

                // Handle new search results and update the UI dynamically
                function handleNewSearch({ query, results }) {
                    console.log("[ytlytics] Updating UI for query:", query, "with results:", results);

                    // Find or create a search section for this query
                    let querySection = document.querySelector(`.search-entry[data-query="${query}"]`);

                    if (!querySection) {
                        querySection = document.createElement("div");
                        querySection.classList.add("search-entry");
                        querySection.setAttribute("data-query", query);
                        querySection.innerHTML = `
                        <h3>Search for: "${query}"</h3>
                        <a href="/word-stats?query=${encodeURIComponent(query)}&sessionId=${sessionId}" target="_blank">Word Statistics</a>
                        <ol class="result-list"></ol>
                    `;
                        historyContainer.prepend(querySection);
                    }

                    // Update results for the query
                    const resultList = querySection.querySelector(".result-list");
                    resultList.innerHTML = results
                            .map(
                                    (result) => `
                            <li class="result-item">
                                <div class="result-content">
                                    <div class="text-content">
                                        <p>
                                            <b>Video Title:</b>
                                            <a href="${result.videoUrl}" target="_blank">${result.title}</a>
                                            <b>Channel:</b>
                                            <a href="/channel/${result.channelId}" target="_blank">${result.channelTitle}</a>
                                            <b>Description:</b> ${result.description}
                                            <b>Tags:</b>
                                            ${result.tags.map((tag) => `<a href="/taglytics/${tag}" target="_blank" class="tag-link">${tag}</a>`).join(", ")}
                                        </p>
                                    </div>
                                    <img src="${result.thumbnailUrl}" alt="Video Thumbnail" class="thumbnail">
                                </div>
                            </li>
                        `
                            )
                            .join("");
                }
        </script>
    </body>
}
